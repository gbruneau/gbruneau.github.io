import"https://cdn.skypack.dev/leaflet@1.7.1";import"https://cdn.skypack.dev/leaflet-rotate@0.1.4";import"https://cdn.skypack.dev/jquery";import"https://maxwell-ilai.github.io/Leaflet.SidePanel/dist/leaflet-sidepanel.min.js";import"https://ppete2.github.io/Leaflet.PolylineMeasure/Leaflet.PolylineMeasure.js";import"https://unpkg.com/leaflet-geotag-photo/dist/Leaflet.GeotagPhoto.min.js";const ye=function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))a(r);new MutationObserver(r=>{for(const i of r)if(i.type==="childList")for(const d of i.addedNodes)d.tagName==="LINK"&&d.rel==="modulepreload"&&a(d)}).observe(document,{childList:!0,subtree:!0});function o(r){const i={};return r.integrity&&(i.integrity=r.integrity),r.referrerpolicy&&(i.referrerPolicy=r.referrerpolicy),r.crossorigin==="use-credentials"?i.credentials="include":r.crossorigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function a(r){if(r.ep)return;r.ep=!0;const i=o(r);fetch(r.href,i)}};ye();var ve=202404301242e-4;const he=[{catID:"BASE",name_en:"Base Map",name_fr:"Carte de base"},{catID:"TOPO",name_en:"Topography",name_fr:"Topographique"},{catID:"IMGE",name_en:"Imagery",name_fr:"Imagerie"},{catID:"TRAN",name_en:"Transport",name_fr:"Transport"},{catID:"MISC",name_en:"Miscelaneoud",name_fr:"Divers"}],Be=[{providerKeyName:"Thunderforest",providerKeyValue:"538d4534960f4226bb8ca146e7df3941"},{providerKeyName:"jawg",providerKeyValue:"e9xKxlmCUuPGGQvk3FYwqWWmXgyvomdDUECpkBfjQA1obipCjNRKwWlHd1pYr5K2"},{providerKeyName:"tracestrack",providerKeyValue:"8e2a46ccbd594da9395b97cf521da27a"}],Me=[{BMKey:0,catID:"BASE",url:"http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",attribution:'OSM Mapnik <a href="http://www.openstreetmap.org/copyright">OpenStreetMap ORG</a>',maxZoom:19,BMname:"Open Street Map",BMicon:"Mapnik.png"},{BMKey:3,catID:"BASE",url:"//{s}.tile.openstreetmap.fr/osmfr/{z}/{x}/{y}.png",attribution:'Map data \xA9 <a href="http://openstreetmap.org">OpenStreetMap FR</a> contributors',maxZoom:20,minZoom:1,BMname:"OSM France",BMicon:"osmFR.png"},{BMKey:1,catID:"BASE",url:"https://tile.jawg.io/4284c312-895e-4aa5-9c79-c8974c53f9d3/{z}/{x}/{y}{r}.png?access-token={key}",keyProvider:"jawg",BMname:"Jawn GB",BMicon:"Jawg_GBMain.png",minZoom:0,maxZoom:22,subdomains:"abcd",attribution:'<a href="http://jawg.io" title="Tiles Courtesy of Jawg Maps" target="_blank">&copy; <b>Jawg</b>Maps</a> &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'},{BMKey:2,catID:"BASE",url:"http://{s}.google.com/vt/lyrs=m&x={x}&y={y}&z={z}",subdomains:["mt0","mt1","mt2","mt3"],BMname:"Google Map",BMicon:"GoogleMap.png",attribution:'<a href="https://maps.google.com">google Map</a>',maxZoom:20},{BMKey:7,catID:"BASE",url:"https://{s}.tile.thunderforest.com/neighbourhood/{z}/{x}/{y}.png?apikey={key}",attribution:'&copy; <a href="http://www.thunderforest.com/">Thunderforest</a>, &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',keyProvider:"Thunderforest",maxZoom:22,BMname:"Thunderforest Neighbourhood",BMicon:"Thunderforest_Neighbourhood.png"},{BMKey:6,catID:"BASE",url:"https://server.arcgisonline.com/ArcGIS/rest/services/NatGeo_World_Map/MapServer/tile/{z}/{y}/{x}",attribution:"Tiles &copy; Esri &mdash; National Geographic, Esri, DeLorme, NAVTEQ, UNEP-WCMC, USGS, NASA, ESA, METI, NRCAN, GEBCO, NOAA, iPCy",BMname:"National Geographic",BMicon:"Esri_NatGeoWorldMap.png"},{BMKey:5,catID:"BASE",url:"https://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}",attribution:"Tiles &copy; Esri &mdash; Esri, DeLorme, NAVTEQ, TomTom, Intermap, iPC, USGS, FAO, NPS, NRCAN, GeoBase, Kadaster NL, Ordnance Survey, Esri Japan, METI, Esri China (Hong Kong), and the GIS User Community",BMname:"ESRI Street",BMicon:"ESRIMap.png"},{BMKey:4,catID:"BASE",url:"https://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png",attribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, Tiles style by <a href="https://www.hotosm.org/" target="_blank">Humanitarian OpenStreetMap Team</a> hosted by <a href="https://openstreetmap.fr" target="_blank">OpenStreetMap France</a>',maxZoom:19,BMname:"Humanitarian OSM",BMicon:"osmHOT.png"},{BMKey:25,catID:"TOPO",url:"https://tile.tracestrack.com/topo_fr/{z}/{x}/{y}.png?key={key}",keyProvider:"tracestrack",BMname:"Tracestack Topo",BMicon:"Tracestrack_Topo.png",attribution:'Data: \xA9 <a href="https://www.openstreetmap.org/copyright">OpenStreetMap contributors</a>, <a href="https://worldcover2021.esa.int">ESA WorldCover</a>; Maps \xA9 <a href="https://www.tracestrack.com/">Tracestrack</a>',minZoom:0,maxZoom:18},{BMKey:8,catID:"TOPO",url:"https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png",maxZoom:17,attribution:'Map data: &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, <a href="http://viewfinderpanoramas.org">SRTM</a> | Map style: &copy; <a href="https://opentopomap.org">OpenTopoMap</a> (<a href="https://creativecommons.org/licenses/by-sa/3.0/">CC-BY-SA</a>)',BMname:"Open Topo Map",BMicon:"OpenTopoMap.png"},{BMKey:11,catID:"TOPO",url:"http://{s}.google.com/vt/lyrs=p&x={x}&y={y}&z={z}",subdomains:["mt0","mt1","mt2","mt3"],BMname:"Google Terrain",BMicon:"GoogleTerrain.png",attribution:'<a href="https://maps.google.com">google Map</a>'},{BMKey:12,catID:"TOPO",url:"https://tiles.stadiamaps.com/tiles/stamen_terrain/{z}/{x}/{y}.{ext}",attribution:'Map tiles by <a href="http://stadiamaps.com">Stamen Design</a>, <a href="http://creativecommons.org/licenses/by/3.0">CC BY 3.0</a> &mdash; Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',subdomains:"abcd",minZoom:1,maxZoom:18,ext:"png",BMname:"Stamen Terrain",BMicon:"Stamen_Terrain.png"},{BMKey:9,catID:"TOPO",url:"https://{s}.tile.thunderforest.com/outdoors/{z}/{x}/{y}.png?apikey={key}",attribution:'&copy; <a href="http://www.thunderforest.com/">Thunderforest</a>, &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',keyProvider:"Thunderforest",maxZoom:22,BMname:"Thunderforest Outdoors",BMicon:"Thunderforest_Outdoors.png"},{BMKey:10,catID:"TOPO",url:"https://{s}.tile.thunderforest.com/landscape/{z}/{x}/{y}.png?apikey={key}",attribution:'&copy; <a href="http://www.thunderforest.com/">Thunderforest</a>, &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',keyProvider:"Thunderforest",maxZoom:22,BMname:"Thunderforest Landscape",BMicon:"Thunderforest_Landscape.png"},{BMKey:13,catID:"TOPO",url:"https://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}",attribution:"Tiles &copy; Esri &mdash; Esri, DeLorme, NAVTEQ, TomTom, Intermap, iPC, USGS, FAO, NPS, NRCAN, GeoBase, Kadaster NL, Ordnance Survey, Esri Japan, METI, Esri China (Hong Kong), and the GIS User Community",BMname:"ESRI Topo",BMicon:"ESRITopo.png"},{BMKey:14,catID:"IMGE",url:"http://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}",subdomains:["mt0","mt1","mt2","mt3"],BMname:"Google Satellite",BMicon:"GoogleSat.png",attribution:'<a href="https://maps.google.com">google Map</a>'},{BMKey:15,catID:"IMGE",url:"https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",BMname:"ESRI Image",BMicon:"ESRIImg.png",attribution:"Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community"},{BMKey:21,catID:"TRAN",url:"https://{s}.basemaps.cartocdn.com/rastertiles/voyager_labels_under/{z}/{x}/{y}{r}.png",attribution:'<a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',subdomains:"abcd",maxZoom:20,BMname:"CartoDB Voyager",BMicon:"CartoDB_VoyagerLabelsUnder.png"},{BMKey:17,catID:"TRAN",url:"https://{s}.tile.thunderforest.com/transport/{z}/{x}/{y}.png?apikey={key}",attribution:'&copy; <a href="http://www.thunderforest.com/">Thunderforest</a>, &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',keyProvider:"Thunderforest",maxZoom:22,BMname:"Thunderforest Transport",BMicon:"Thunderforest_Transport.png"},{BMKey:20,catID:"TRAN",url:"https://{s}.tile.thunderforest.com/cycle/{z}/{x}/{y}.png?apikey={key}",attribution:'&copy; <a href="http://www.thunderforest.com/">Thunderforest</a>, &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',keyProvider:"Thunderforest",maxZoom:22,BMname:"Thunderforest Cycle",BMicon:"Thunderforest_OpenCycleMap.png"},{BMKey:19,catID:"TRAN",url:"https://{s}.tile-cyclosm.openstreetmap.fr/cyclosm/{z}/{x}/{y}.png",maxZoom:20,attribution:'<a href="https://github.com/cyclosm/cyclosm-cartocss-style/releases" title="CyclOSM - Open Bicycle render">CyclOSM</a> | Map data: &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',BMname:"Cyclo OSM",BMicon:"CyclOSM.png"},{BMKey:16,catID:"TRAN",url:"https://{s}.tile.thunderforest.com/mobile-atlas/{z}/{x}/{y}.png?apikey={key}",attribution:'&copy; <a href="http://www.thunderforest.com/">Thunderforest</a>, &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',keyProvider:"Thunderforest",maxZoom:22,BMname:"Thunderforest Mobile Atlas",BMicon:"Thunderforest_MobileAtlas.png"},{BMKey:18,catID:"TRAN",url:"https://{s}.tile.thunderforest.com/transport-dark/{z}/{x}/{y}.png?apikey={key}",attribution:'&copy; <a href="http://www.thunderforest.com/">Thunderforest</a>, &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',keyProvider:"Thunderforest",maxZoom:22,BMname:"Thunderforest Transport Dark",BMicon:"Thunderforest_TransportDark.png"},{BMKey:23,catID:"MISC",url:"https://tiles.stadiamaps.com/tiles/stamen_toner_lite/{z}/{x}/{y}{r}.{ext}",BMname:"Stamen Toner Lite",BMicon:"Stamen_TonerLite.png",attribution:'Map tiles by <a href="http://stadiamaps.com">Stamen Design</a>, <a href="http://creativecommons.org/licenses/by/3.0">CC BY 3.0</a> &mdash; Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',subdomains:"abcd",minZoom:0,maxZoom:20,ext:"png"},{BMKey:22,catID:"MISC",url:"https://{s}.tile.thunderforest.com/pioneer/{z}/{x}/{y}.png?apikey={key}",attribution:'&copy; <a href="http://www.thunderforest.com/">Thunderforest</a>, &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',keyProvider:"Thunderforest",maxZoom:22,BMname:"Thunderforest Pioneer",BMicon:"Thunderforest_Pioneer.png"},{BMKey:24,catID:"MISC",url:"https://tiles.stadiamaps.com/tiles/stamen_watercolor/{z}/{x}/{y}.{ext}",attribution:'Map tiles by <a href="http://stadiamaps.com">Stamen Design</a>, <a href="http://creativecommons.org/licenses/by/3.0">CC BY 3.0</a> &mdash; Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',subdomains:"abcd",minZoom:1,maxZoom:16,ext:"jpg",BMname:"Stamen Watercolor",BMicon:"Stamen_Watercolor.jpg"}];var P={categories:he,providerKeys:Be,layers:Me},be="hsl(197, 100%, 60%)",Ee=window.location.search,c=new URLSearchParams(Ee),ee=c.has("z")==!0?Number(c.get("z")):10,te=c.has("lat")==!0?Number(c.get("lat")):46.80960630088855,oe=c.has("lng")==!0?Number(c.get("lng")):-71.21267080307008,ne=c.has("rot")==!0?Number(c.get("rot")):0,V=c.has("m")==!0?c.get("m").toString()=="true":!1,ae=c.has("t")==!0?c.get("t"):"New Map",re=c.has("l")==!0?c.get("l"):25;const Ie=1e3;var f=[];for(const t of P.categories){var A={catID:t.catID,category:t.name_fr,layers:[]};for(const e of P.layers)if(e.catID==A.catID){var W=e.url;if(e.keyProvider!==void 0){var Y=Le(e.keyProvider);Y!==void 0&&(W=e.url.replace("{key}",Y))}var g=L.tileLayer(W,{});e.BMKey!==void 0&&(g.options.BMKey=e.BMKey),e.BMname!==void 0&&(g.options.BMname=e.BMname),e.BMicon!==void 0&&(g.options.BMicon=e.BMicon),e.BMicon!==void 0&&(g.options.BMicon=e.BMicon),e.attribution!==void 0&&(g.options.attribution=e.attribution),e.minZoom!==void 0&&(g.options.minZoom=e.minZoom),e.maxZoom!==void 0&&(g.options.maxZoom=e.maxZoom),e.subdomains!==void 0&&(g.options.subdomains=e.subdomains),e.ext!==void 0&&(g.options.ext=e.ext),A.layers.push(g)}f.push(A)}var n=L.map("map",{center:new L.LatLng(te,oe),zoom:ee,zoomControl:!1,rotate:!0,touchRotate:!0,rotateControl:!1,BMHasMarker:!1,BMTitle:ae,bearing:ne,attributionControl:!0,BMHasMeasure:!1,BMHasTracker:!1,BMCurrentLayerKey:0}),u={},we=G(re);n.addLayer(we);document.getElementById("buildFld").value=ve;L.control.sidepanel("panelID",{panelPosition:"left",hasTabs:!0,tabsPosition:"top",pushControls:!0,darkMode:!0,startTab:"tab-layer"}).addTo(n);var ie=L.control({position:"topright"});ie.onAdd=function(t){var e=L.DomUtil.create("div","info legend nArrow");return e.innerHTML="\u27F4",e};ie.addTo(n);var Te=document.querySelector(".nArrow");Te.addEventListener("click",function(t){n.setBearing(0)});let se=L.control.polylineMeasure({position:"topright",unit:"kilometres",showBearings:!1,clearMeasurementsOnStop:!0,showClearControl:!1,showUnitControl:!1,startCircle:{color:"#000",weight:2,fillColor:"#0f0",fillOpacity:1,radius:6},intermedCircle:{color:"#000",weight:2,fillColor:"#ff0",fillOpacity:1,radius:4},currentCircle:{color:"#000",weight:1,fillColor:"#f0f",fillOpacity:1,radius:3},endCircle:{color:"#000",weight:2,fillColor:"#f00",fillOpacity:1,radius:6},tempLine:{color:"#00f",weight:1},fixedLine:{color:"#00C",weight:3}});se.addTo(n);document.querySelector(".polyline-measure-unicode-icon").parentNode.style.display="none";n.on("rotate",function(t){O(Z(n.getBearing()))});n.on("resizeend",function(t){y(w()),v(T()),k(D())});n.on("zoomend",function(t){k(n.getZoom())});n.on("moveend",function(t){y(w()),v(T())});V?pe():x(V);Ae();Pe();He();qe();Ve();I(ae);O(ne);y(te);v(oe);k(ee);me(re);ce(!1);de(!1);let le,F=!1,R=!1;var K=indexedDB.open("BestMapDB",1),M,h="BMFavorite";K.onerror=function(t){console.log("Database error: "+t.target.errorCode)};K.onsuccess=function(t){M=t.target.result,console.log("Database opened successfully"),ue()};K.onupgradeneeded=function(t){M=t.target.result;var e=M.createObjectStore(h,{keyPath:"t"});e.createIndex("m","m",{unique:!1}),e.createIndex("rot","rot",{unique:!1}),e.createIndex("l","l",{unique:!1}),e.createIndex("lat","lat",{unique:!1}),e.createIndex("lng","lng",{unique:!1}),e.createIndex("z","z",{unique:!1})};document.getElementById("dlgUpload").style.display="none";document.getElementById("dlgconfirm").style.display="none";function Le(t){var e;for(const o of P.providerKeys)o.providerKeyName==t&&(e=o.providerKeyValue);return e}function B(t,e){var o=new URLSearchParams(window.location.search);o.set(t,e),window.history.pushState({},n.options.BMTitle,`${location.pathname}?${o.toString()}`)}function ke(){return n.options.BMTitle}function I(t){n.options.BMTitle=t,document.getElementById("fTitle").value=t,document.title=`BestMap: ${t}`,n.options.BMHasMarker&&u.setTooltipContent(t),B("t",t)}function E(){return Z(n.getBearing())}function O(t){document.getElementById("fRot").value=t,B("rot",t);var e=document.querySelector(".nArrow");e.style.transform=`rotate(${t-90}deg)`,t==0?e.style.display="none":e.style.display="block"}function y(t){document.getElementById("fLat").value=t,B("lat",t)}function w(){var t;return n.options.BMHasMarker?t=u.getLatLng().lat:t=n.getCenter().lat,t}function T(){var t;return n.options.BMHasMarker?t=u.getLatLng().lng:t=n.getCenter().lng,t}function v(t){document.getElementById("fLng").value=t,B("lng",t)}function D(){return n.getZoom()}function k(t){document.getElementById("fZoom").value=t,B("z",t)}function x(t){t?(u.setTooltipContent(n.options.BMTitle),document.getElementById("btFlipMarker").style.backgroundImage="url('icons/removeMarker.png')"):document.getElementById("btFlipMarker").style.backgroundImage="url('icons/addMarker.png')",B("m",t)}function ce(t){t?document.getElementById("btMeasure").style.backgroundImage="url('icons/removeMeasure.png')":document.getElementById("btMeasure").style.backgroundImage="url('icons/addMeasure.png')"}function de(t){t?document.getElementById("btTrack").style.backgroundImage="url('icons/removeTrack.png')":document.getElementById("btTrack").style.backgroundImage="url('icons/addTrack.png')"}function Se(t){var a=18-Math.log(t)/Math.log(10);return a=Math.max(0,Math.min(a,18)),a}function Ce(t){var e=t.coords,o=Se(e.accuracy);$(),n.flyTo(new L.LatLng(e.latitude,e.longitude),o),n.once("moveend zoomend",function(){_(e.latitude,e.longitude),I("you are here")})}function Oe(t){t.code==1?console.log("getCurrentPosition Error: Access is denied!"):t.code==2&&console.log("getCurrentPosition Error: Position is unavailable!")}function Z(t){var e=parseInt(t);return t<0?e=360- -t%360:e=t%360,parseInt(e)}function De(t){var e=parseFloat(t);return e>90&&(e=90),e<-90&&(e=-90),e}function xe(t){var e=parseFloat(t);return e>180&&(e=180),e<-180&&(e=-180),e}function Ne(t){var e=parseInt(t);return e>n.maxZoom&&(e=n.maxZoom),e<n.minZoom&&(e=n.minZoom),e}function z(t){var e=parseInt(t);isNaN(e)&&(e=0),n.eachLayer(function(o){"BMname"in o.options&&n.removeLayer(o)}),n.addLayer(G(e)),me(e)}function Ae(){for(var t=document.getElementById("BM-Layer-Nav-Panel"),e=0,o=0;o<f.length;o++){for(var a='<div class="BM-Layer-Nav-Container">',r=f[o].layers,i=0;i<r.length;i++){var d=`BMLayer-${e}`;a+=`<div class="BM-Layer-Bt" id="${d}" data-bmkey="${f[o].layers[i].options.BMKey}" >
              <img src='layerIcons/${r[i].options.BMicon}' title='${f[o].layers[i].options.BMname}'>
              <div class="BM-Layer-Bt-Name">${f[o].layers[i].options.BMname}</div>
            </div>`,e++}a+="</div>";var m=`<div class="BM-Layer-Nav-Category">${f[o].category}</div>${a}`;t.innerHTML+=m}}function G(t){var e,o,a=parseInt(t);isNaN(a)&&(a=0);for(var r=0;r<f.length;r++){o=f[r].layers;for(var i=0;i<o.length;i++)r===0&&i===0&&(e=o[i]),o[i].options.BMKey===a&&(e=o[i])}return e}function me(t){for(var e=document.querySelectorAll(".BM-Layer-Bt"),o=0;o<e.length;o++){var a=e[o].getElementsByTagName("img")[0];e[o].dataset.BMKey==t?a.style.borderColor=be:a.style.borderColor="black"}document.getElementById("fLayer").value=G(t).options.BMname,document.getElementById("fLayerID").value=t,B("l",t),n.options.BMCurrentLayerKey=t}function Pe(){document.addEventListener("click",function(t){if(t.target.matches(".BM-Layer-Bt img")){var e=t.target.parentNode.dataset.bmkey;z(e)}if(t.target.matches(".BM-Layer-Bt div")){var e=t.target.parentNode.dataset.bmkey;z(e)}},!1)}function S(){return n.options.BMHasMarker?u.getLatLng():n.getCenter()}const ze=document.querySelector("#btSelFavFile");ze.addEventListener("change",t=>{if(t.target.files.length==1){const[e]=t.target.files,{name:o,size:a}=e,r=(a/1e3).toFixed(2),i=`${o} (${r}KB)`;document.querySelector("#selectedFavFileName").textContent=i,document.querySelector("#btFavDoUpload").style.display="block"}else document.querySelector("#selectedFavFileName").textContent="",document.querySelector("#btFavDoUpload").style.display="none"});function Fe(){document.getElementById("dlgUpload").style.display="block"}function Re(t){let e=t.target.result,o=JSON.parse(e);var a=document.getElementById("FavTableBody");a.innerHTML="";for(let i=0;i<o.length;i++){var r=o[i];U(r.t,r.m,r.rot,r.lat,r.lng,r.z,r.l)}}function Ke(){document.getElementById("dlgUpload").style.display="none"}function Ze(){let t=document.getElementById("btSelFavFile");if(!t.value.length)return;let e=new FileReader;e.onload=Re,e.readAsText(t.files[0]),document.getElementById("dlgUpload").style.display="none"}function Ge(t,e,o){const a=document.createElement("a"),r=new Blob([t],{type:o});a.href=URL.createObjectURL(r),a.download=e,a.click()}function Ue(t){var e=M.transaction([h],"readonly"),o=e.objectStore(h),a=o.getAll();a.onsuccess=function(r){var i=r.target.result;console.log("Data read successfully"),t(i)},a.onerror=function(r){console.log("Error reading data: "+r.target.errorCode)}}function ue(){Ue(function(t){var e;for(e of t)U(e.t,e.m,e.rot,e.lat,e.lng,e.z,e.l);ge("FavTable",0,!1)})}function _e(){var t=M.transaction([h],"readwrite"),e=t.objectStore(h),o=e.clear();o.onsuccess=function(a){console.log("All data deleted successfully")},o.onerror=function(a){console.log("Error deleting all data: "+a.target.errorCode)}}function $e(t){var e=M.transaction([h],"readwrite"),o=e.objectStore(h),a=o.add(t);a.onsuccess=function(r){console.log("Data inserted successfully")},a.onerror=function(r){console.log("Error inserting data: "+r.target.errorCode)}}function U(t,e,o,a,r,i,d){const l=document.getElementById("FavTableBody").insertRow(0);var p=self.crypto.randomUUID(),b=self.crypto.randomUUID(),H=self.crypto.randomUUID(),q=self.crypto.randomUUID(),fe=self.crypto.randomUUID(),j="";j=`
  <tr id="${fe}">
    <td id="${p}" class="BM-Table-Input" contenteditable="true">${t}</td>
    <td id="${b}" class="BM-Table-Icon" ><img src="./icons/favView.png"></td>
    <td id="${H}" class="BM-Table-Icon"><img src="./icons/favUpdate.png"</td>
    <td id="${q}" class="BM-Table-Icon"><img src="./icons/favDelete.png"</td>
  </tr>`,l.innerHTML=j,l.dataset.m=e,l.dataset.t=t,l.dataset.rot=o,l.dataset.lat=a,l.dataset.lng=r,l.dataset.z=i,l.dataset.l=d,document.getElementById(b).addEventListener("click",function(){var s=this.parentNode.dataset;$(),n.panTo({lng:Number(s.lng),lat:Number(s.lat)}),n.setZoom(s.z),k(s.z),n.setBearing(Number(s.rot)),z(Number(s.l)),n.options.BMTitle=s.t,console.log(`GB: BMHasMarker = ${n.options.BMHasMarker}`),console.log(`GB: theUrlObj = ${JSON.stringify(s)}`),console.log(`GB: theUrlObj m type = ${typeof s.m}`),s.m=="true"&&(_(s.lat,s.lng),x(!0),n.options.BMHasMarke=!0,n.panTo({lng:Number(s.lng),lat:Number(s.lat)})),n.panTo({lng:Number(s.lng),lat:Number(s.lat)}),y(Number(s.lat)),v(Number(s.lng)),I(s.t)}),document.getElementById(H).addEventListener("click",function(){var s=this.parentNode.dataset;document.getElementById("dlgconfirm").style.display="block",document.getElementById("conQuestion").innerText=`Do you update the saved view for: ${s.t}?`,document.getElementById("btConfNo").addEventListener("click",function(){document.getElementById("dlgconfirm").style.display="none"}),document.getElementById("btConfYes").addEventListener("click",function(){s.m=n.options.BMHasMarker,s.rot=E(),s.lat=w(),s.lng=T(),s.z=D(),s.l=n.options.BMCurrentLayerKey,document.getElementById("dlgconfirm").style.display="none"})}),document.getElementById(q).addEventListener("click",function(){this.parentNode.remove()}),document.getElementById(p).addEventListener("input",function(s){var N=s.target.innerText;n.options.BMTitle!==N&&I(N),this.parentNode.dataset.t=N})}function He(){document.getElementById("btGoOSM").addEventListener("click",function(){var t=S(),e=n.getZoom(),o=`https://www.openstreetmap.org/#map=${e}/${t.lat}/${t.lng}`;window.open(o)}),document.getElementById("btGoGoogle").addEventListener("click",function(){var t=S(),e=`https://www.google.com/maps/search/?api=1&query=${t.lat},${t.lng}`;window.open(e)}),document.getElementById("btGoGoogleEarth").addEventListener("click",function(){var t=S(),e=n.getZoom(),o=E(),a=Math.pow(2,20-e)*4096;console.log(`z=${e} d=${a}`);var r=`https://earth.google.com/web/@${t.lat},${t.lng},${a}d,${-o}h`;window.open(r)}),document.getElementById("btGoBing").addEventListener("click",function(){var t=S(),e=n.getZoom(),o=E(),a=-o,r=`https://www.bing.com/maps?cp=${t.lat}~${t.lng}&lvl=${e}&dir=${a}`;console.log(r),window.open(r)}),document.getElementById("btFavAdd").addEventListener("click",function(){U("*** name ***",n.options.BMHasMarker,E(),w(),T(),D(),n.options.BMCurrentLayerKey)}),document.getElementById("btFavSave").addEventListener("click",function(){_e();for(var t=document.getElementById("FavTableBody"),e=0,o;o=t.rows[e];e++){var a={t:o.dataset.t,m:o.dataset.m,rot:o.dataset.rot,l:o.dataset.l,lat:o.dataset.lat,lng:o.dataset.lng,z:o.dataset.z};$e(a)}}),document.getElementById("btFavUndo").addEventListener("click",function(){var t=document.getElementById("FavTableBody");t.innerHTML="",ue()}),document.getElementById("btFavExport").addEventListener("click",function(){for(var t=document.getElementById("FavTableBody"),e=[],o=0,a;a=t.rows[o];o++){var r={t:a.dataset.t,m:a.dataset.m,rot:a.dataset.rot,l:a.dataset.l,lat:a.dataset.lat,lng:a.dataset.lng,z:a.dataset.z};e.push(r)}Ge(JSON.stringify(e),"BMFavorites.json","text/plain")}),document.getElementById("btFavImport").addEventListener("click",Fe),document.getElementById("btFavCancelUpload").addEventListener("click",Ke),document.getElementById("btFavDoUpload").addEventListener("click",Ze),document.getElementById("btFlipMarker").addEventListener("click",function(){We()}),document.getElementById("btTrack").addEventListener("click",function(){ot()}),document.getElementById("btGoHere").addEventListener("click",function(){navigator.geolocation&&navigator.geolocation.getCurrentPosition(Ce,Oe)}),document.getElementById("shareToClipboard").addEventListener("click",function(){navigator.clipboard.writeText(window.location.href)}),document.getElementById("shareToMail").addEventListener("click",function(){var t=encodeURIComponent(window.location.href),e=encodeURIComponent(n.options.BMTitle),o=`mailto:?subject=${e}&body=${e}%0A${t}`;document.location=o}),document.getElementById("btMeasure").addEventListener("click",function(){se._toggleMeasure(),n.options.BMHasMeasure=!n.options.BMHasMeasure,ce(n.options.BMHasMeasure)}),document.getElementById("headFavPlace").addEventListener("click",function(){ge("FavTable",0,!1)})}function J(){document.getElementById("btEdit").style.display="inline-block",document.getElementById("btEditSave").style.display="none",document.getElementById("btEditCancel").style.display="none",document.getElementById("fTitle").disabled=!0,document.getElementById("fRot").disabled=!0,document.getElementById("fLat").disabled=!0,document.getElementById("fLng").disabled=!0,document.getElementById("fZoom").disabled=!0}function qe(){var t,e,o,a,r;document.getElementById("btEdit").addEventListener("click",function(){t=ke(),e=E(),o=w(),a=T(),r=D(),document.getElementById("btEdit").style.display="none",document.getElementById("btEditSave").style.display="inline-block",document.getElementById("btEditCancel").style.display="inline-block",document.getElementById("fTitle").disabled=!1,document.getElementById("fRot").disabled=!1,document.getElementById("fLat").disabled=!1,document.getElementById("fLng").disabled=!1,document.getElementById("fZoom").disabled=!1}),document.getElementById("btEditSave").addEventListener("click",function(){J();var i=document.getElementById("fTitle").value;i!=t&&I(i);var d=Z(document.getElementById("fRot").value);d!=e&&(n.setBearing(d),O(d));var m=De(document.getElementById("fLat").value),l=xe(document.getElementById("fLng").value);(m!=o||l!=a)&&(n.panTo(new L.LatLng(m,l),p),m!=o&&y(m),l!=a&&v(l));var p=Ne(document.getElementById("fZoom").value);p!=r&&(n.setZoom(p),k(p))}),document.getElementById("btEditCancel").addEventListener("click",function(){J(),document.getElementById("fTitle").value=t,document.getElementById("fRot").value=e})}function je(t){if(console.log(t),Array.isArray(t.results)&&t.results.length>0){var e=t.results[0],o=e.geometry.lat,a=e.geometry.lng;n.panTo(new L.LatLng(o,a),{}),y(o),v(a)}}function Ve(){document.getElementById("fSearch").addEventListener("change",function(){var t=document.getElementById("fSearch").value,e="a1f15d3f6b834c55917fd7e435af418c",o=`https://api.opencagedata.com/geocode/v1/json?q=${t}&key=${e}`;console.log(t),fetch(o).then(a=>a.json()).then(a=>je(a))})}function _(t,e){u=new L.Marker([t,e],{draggable:!0}),u.bindTooltip(n.options.BMTitle),u.on("dragend",function(o){var a=u.getLatLng().lat,r=u.getLatLng().lng;y(a),v(r)}),n.addLayer(u),n.options.BMHasMarker=!0,x(!0)}function pe(){var t=n.getCenter().lat,e=n.getCenter().lng;_(t,e)}function We(){Ye()?$():pe()}function Ye(){var t=!1;return n.eachLayer(e=>{e instanceof L.Marker&&(t=!0)}),t}function $(){n.eachLayer(t=>{t instanceof L.Marker&&t.remove()}),n.options.BMHasMarker=!1,x(!1)}function Q(){window.DeviceMotionEvent&&window.DeviceMotionEvent.requestPermission?window.DeviceMotionEvent.requestPermission().then(t=>{t==="granted"&&window.addEventListener("devicemotion",C)}).catch(console.error):window.DeviceOrientationEvent?window.addEventListener("deviceorientationabsolute",C):console.log("Device motion or orientation is not supported by this browser.")}function C(t){let e=null;if(t.rotationRate?e=t.rotationRate.alpha:t.alpha&&(e=t.alpha),e!==null){const o=e;R&&(n.setBearing(o),O(o))}}function Je(){R=!0,Q(),setInterval(Q,Ie)}function Qe(){R=!1,window.DeviceMotionEvent&&window.DeviceMotionEvent.requestPermission?window.removeEventListener("devicemotion",C):window.DeviceOrientationEvent&&window.removeEventListener("deviceorientationabsolute",C)}function X(){navigator.geolocation?navigator.geolocation.getCurrentPosition(Xe):console.log("Geolocation is not supported by this browser.")}function Xe(t){var e=t.coords.latitude,o=t.coords.longitude;F&&(y(e),v(o),n.panTo({lng:o,lat:e}))}function et(){F=!0,X(),le=setInterval(X,1e4)}function tt(){F=!1,clearInterval(le)}function ot(){n.options.BMHasTracker?(L.geotagPhoto.crosshair().removeFrom(n),document.querySelectorAll(".leaflet-geotag-photo-crosshair").forEach(e=>e.remove()),tt(),Qe()):(L.geotagPhoto.crosshair().addTo(n).on("input",function(t){this.getCrosshairPoint()}),et(),Je()),n.options.BMHasTracker=!n.options.BMHasTracker,de(n.options.BMHasTracker)}function ge(t,e,o=!1){const a=document.getElementById(t),r=a.querySelector("tbody"),i=Array.from(r.getElementsByTagName("tr")),d=a.querySelector("thead tr");i.sort((m,l)=>{const p=m.getElementsByTagName("td")[e].textContent.trim(),b=l.getElementsByTagName("td")[e].textContent.trim();return o?b.localeCompare(p):p.localeCompare(b)}),o&&i.reverse(),r.innerHTML="",i.forEach(m=>r.appendChild(m)),a.querySelector("thead").appendChild(d)}
