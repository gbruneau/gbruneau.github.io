import"https://cdn.skypack.dev/leaflet@1.7.1";import"https://cdn.skypack.dev/leaflet-rotate@0.1.4";import"https://cdn.skypack.dev/jquery";import"https://maxwell-ilai.github.io/Leaflet.SidePanel/dist/leaflet-sidepanel.min.js";import"https://ppete2.github.io/Leaflet.PolylineMeasure/Leaflet.PolylineMeasure.js";import"https://unpkg.com/leaflet-geotag-photo/dist/Leaflet.GeotagPhoto.min.js";const Se=function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))a(n);new MutationObserver(n=>{for(const i of n)if(i.type==="childList")for(const m of i.addedNodes)m.tagName==="LINK"&&m.rel==="modulepreload"&&a(m)}).observe(document,{childList:!0,subtree:!0});function o(n){const i={};return n.integrity&&(i.integrity=n.integrity),n.referrerpolicy&&(i.referrerPolicy=n.referrerpolicy),n.crossorigin==="use-credentials"?i.credentials="include":n.crossorigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function a(n){if(n.ep)return;n.ep=!0;const i=o(n);fetch(n.href,i)}};Se();var Ce=202406271207e-4;const xe=[{catID:"BASE",name_en:"Base Map",name_fr:"Carte de base"},{catID:"TOPO",name_en:"Topography",name_fr:"Topographique"},{catID:"IMGE",name_en:"Imagery",name_fr:"Imagerie"},{catID:"TRAN",name_en:"Transport",name_fr:"Transport"},{catID:"MISC",name_en:"Miscelaneoud",name_fr:"Divers"}],Oe=[{providerKeyName:"Thunderforest",providerKeyValue:"538d4534960f4226bb8ca146e7df3941"},{providerKeyName:"jawg",providerKeyValue:"e9xKxlmCUuPGGQvk3FYwqWWmXgyvomdDUECpkBfjQA1obipCjNRKwWlHd1pYr5K2"},{providerKeyName:"tracestrack",providerKeyValue:"8e2a46ccbd594da9395b97cf521da27a"},{providerKeyName:"stadiamaps",providerKeyValue:"b47c1f97-1372-4024-b0cf-d60b46bb1787"},{providerKeyName:"here",providerKeyValue:"NHG82qG2ayXOLV2PQKbPG1Pbt393JTTJ-oX8KkZMdyw"}],Ne=[{BMKey:0,catID:"BASE",url:"http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",attribution:'OSM Mapnik <a href="http://www.openstreetmap.org/copyright">OpenStreetMap ORG</a>',minZoom:1,maxZoom:19,BMname:"Open Street Map",BMicon:"Mapnik.png"},{BMKey:3,catID:"BASE",url:"//{s}.tile.openstreetmap.fr/osmfr/{z}/{x}/{y}.png",attribution:'Map data \xA9 <a href="http://openstreetmap.org">OpenStreetMap FR</a> contributors',maxZoom:20,minZoom:0,BMname:"OSM France",BMicon:"osmFR.png"},{BMKey:1,catID:"BASE",url:"https://tile.jawg.io/4284c312-895e-4aa5-9c79-c8974c53f9d3/{z}/{x}/{y}{r}.png?access-token={key}",keyProvider:"jawg",BMname:"Jawn GB",BMicon:"Jawg_GBMain.png",minZoom:0,maxZoom:22,subdomains:"abcd",attribution:'<a href="http://jawg.io" title="Tiles Courtesy of Jawg Maps" target="_blank">&copy; <b>Jawg</b>Maps</a> &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'},{BMKey:2,catID:"BASE",url:"http://{s}.google.com/vt/lyrs=m&x={x}&y={y}&z={z}",subdomains:["mt0","mt1","mt2","mt3"],BMname:"Google Map",BMicon:"GoogleMap.png",attribution:'<a href="https://maps.google.com">google Map</a>',maxZoom:20},{BMKey:7,catID:"BASE",url:"https://{s}.tile.thunderforest.com/neighbourhood/{z}/{x}/{y}.png?apikey={key}",attribution:'&copy; <a href="http://www.thunderforest.com/">Thunderforest</a>, &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',keyProvider:"Thunderforest",maxZoom:22,BMname:"Thunderforest Neighbourhood",BMicon:"Thunderforest_Neighbourhood.png"},{BMKey:6,catID:"BASE",url:"https://server.arcgisonline.com/ArcGIS/rest/services/NatGeo_World_Map/MapServer/tile/{z}/{y}/{x}",attribution:"Tiles &copy; Esri &mdash; National Geographic, Esri, DeLorme, NAVTEQ, UNEP-WCMC, USGS, NASA, ESA, METI, NRCAN, GEBCO, NOAA, iPCy",BMname:"National Geographic",BMicon:"Esri_NatGeoWorldMap.png"},{BMKey:5,catID:"BASE",url:"https://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}",attribution:"Tiles &copy; Esri &mdash; Esri, DeLorme, NAVTEQ, TomTom, Intermap, iPC, USGS, FAO, NPS, NRCAN, GeoBase, Kadaster NL, Ordnance Survey, Esri Japan, METI, Esri China (Hong Kong), and the GIS User Community",BMname:"ESRI Street",BMicon:"ESRIMap.png"},{BMKey:4,catID:"BASE",url:"https://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png",attribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, Tiles style by <a href="https://www.hotosm.org/" target="_blank">Humanitarian OpenStreetMap Team</a> hosted by <a href="https://openstreetmap.fr" target="_blank">OpenStreetMap France</a>',maxZoom:19,BMname:"Humanitarian OSM",BMicon:"osmHOT.png"},{BMKey:25,catID:"TOPO",url:"https://tile.tracestrack.com/topo_fr/{z}/{x}/{y}.png?key={key}",keyProvider:"tracestrack",BMname:"Tracestack Topo",BMicon:"Tracestrack_Topo.png",attribution:'Data: \xA9 <a href="https://www.openstreetmap.org/copyright">OpenStreetMap contributors</a>, <a href="https://worldcover2021.esa.int">ESA WorldCover</a>; Maps \xA9 <a href="https://www.tracestrack.com/">Tracestrack</a>',minZoom:0,maxZoom:19},{BMKey:8,catID:"TOPO",url:"https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png",maxZoom:17,attribution:'Map data: &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, <a href="http://viewfinderpanoramas.org">SRTM</a> | Map style: &copy; <a href="https://opentopomap.org">OpenTopoMap</a> (<a href="https://creativecommons.org/licenses/by-sa/3.0/">CC-BY-SA</a>)',BMname:"Open Topo Map",BMicon:"OpenTopoMap.png"},{BMKey:11,catID:"TOPO",url:"http://{s}.google.com/vt/lyrs=p&x={x}&y={y}&z={z}",subdomains:["mt0","mt1","mt2","mt3"],BMname:"Google Terrain",BMicon:"GoogleTerrain.png",attribution:'<a href="https://maps.google.com">google Map</a>'},{BMKey:12,catID:"TOPO",url:"https://tiles.stadiamaps.com/tiles/stamen_terrain/{z}/{x}/{y}.{ext}",attribution:'Map tiles by <a href="http://stadiamaps.com">Stamen Design</a>, <a href="http://creativecommons.org/licenses/by/3.0">CC BY 3.0</a> &mdash; Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',subdomains:"abcd",minZoom:1,maxZoom:18,ext:"png",BMname:"Stamen Terrain",BMicon:"Stamen_Terrain.png"},{BMKey:9,catID:"TOPO",url:"https://{s}.tile.thunderforest.com/outdoors/{z}/{x}/{y}.png?apikey={key}",attribution:'&copy; <a href="http://www.thunderforest.com/">Thunderforest</a>, &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',keyProvider:"Thunderforest",maxZoom:22,BMname:"Thunderforest Outdoors",BMicon:"Thunderforest_Outdoors.png"},{BMKey:10,catID:"TOPO",url:"https://{s}.tile.thunderforest.com/landscape/{z}/{x}/{y}.png?apikey={key}",attribution:'&copy; <a href="http://www.thunderforest.com/">Thunderforest</a>, &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',keyProvider:"Thunderforest",maxZoom:22,BMname:"Thunderforest Landscape",BMicon:"Thunderforest_Landscape.png"},{BMKey:13,catID:"TOPO",url:"https://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}",attribution:"Tiles &copy; Esri &mdash; Esri, DeLorme, NAVTEQ, TomTom, Intermap, iPC, USGS, FAO, NPS, NRCAN, GeoBase, Kadaster NL, Ordnance Survey, Esri Japan, METI, Esri China (Hong Kong), and the GIS User Community",BMname:"ESRI Topo",BMicon:"ESRITopo.png"},{BMKey:14,catID:"IMGE",url:"http://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}",subdomains:["mt0","mt1","mt2","mt3"],BMname:"Google Satellite",BMicon:"GoogleSat.png",minZoom:1,maxZoom:21,attribution:'<a href="https://maps.google.com">google Map</a>'},{BMKey:3026,catID:"IMGE",url:"https://1.aerial.maps.ls.hereapi.com/maptile/2.1/maptile/newest/satellite.day/{z}/{x}/{y}/512/jpg?apiKey={key}",attribution:"Here Map",minZoom:1,maxZoom:19,BMname:"Here Satellite",BMicon:"Here_Satellite.jpg",keyProvider:"here"},{BMKey:15,catID:"IMGE",url:"https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",BMname:"ESRI Image",BMicon:"ESRIImg.png",minZoom:1,maxZoom:21,attribution:"Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community"},{BMKey:21,catID:"TRAN",url:"https://{s}.basemaps.cartocdn.com/rastertiles/voyager_labels_under/{z}/{x}/{y}{r}.png",attribution:'<a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',subdomains:"abcd",maxZoom:20,BMname:"CartoDB Voyager",BMicon:"CartoDB_VoyagerLabelsUnder.png"},{BMKey:17,catID:"TRAN",url:"https://{s}.tile.thunderforest.com/transport/{z}/{x}/{y}.png?apikey={key}",attribution:'&copy; <a href="http://www.thunderforest.com/">Thunderforest</a>, &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',keyProvider:"Thunderforest",maxZoom:22,BMname:"Thunderforest Transport",BMicon:"Thunderforest_Transport.png"},{BMKey:20,catID:"TRAN",url:"https://{s}.tile.thunderforest.com/cycle/{z}/{x}/{y}.png?apikey={key}",attribution:'&copy; <a href="http://www.thunderforest.com/">Thunderforest</a>, &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',keyProvider:"Thunderforest",maxZoom:22,BMname:"Thunderforest Cycle",BMicon:"Thunderforest_OpenCycleMap.png"},{BMKey:19,catID:"TRAN",url:"https://{s}.tile-cyclosm.openstreetmap.fr/cyclosm/{z}/{x}/{y}.png",maxZoom:20,attribution:'<a href="https://github.com/cyclosm/cyclosm-cartocss-style/releases" title="CyclOSM - Open Bicycle render">CyclOSM</a> | Map data: &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',BMname:"Cyclo OSM",BMicon:"CyclOSM.png"},{BMKey:16,catID:"TRAN",url:"https://{s}.tile.thunderforest.com/mobile-atlas/{z}/{x}/{y}.png?apikey={key}",attribution:'&copy; <a href="http://www.thunderforest.com/">Thunderforest</a>, &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',keyProvider:"Thunderforest",maxZoom:22,BMname:"Thunderforest Mobile Atlas",BMicon:"Thunderforest_MobileAtlas.png"},{BMKey:18,catID:"TRAN",url:"https://{s}.tile.thunderforest.com/transport-dark/{z}/{x}/{y}.png?apikey={key}",attribution:'&copy; <a href="http://www.thunderforest.com/">Thunderforest</a>, &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',keyProvider:"Thunderforest",maxZoom:22,BMname:"Thunderforest Transport Dark",BMicon:"Thunderforest_TransportDark.png"},{BMKey:27,catID:"MISC",url:"https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png",attribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',subdomains:"abcd",minZoom:0,maxZoom:20,BMname:"CartoDB Positron",BMicon:"CartoDB_Positron.png"},{BMKey:23,catID:"MISC",url:"https://tiles.stadiamaps.com/tiles/stamen_toner_lite/{z}/{x}/{y}{r}.{ext}",BMname:"Stamen Toner Lite",BMicon:"Stamen_TonerLite.png",attribution:'Map tiles by <a href="http://stadiamaps.com">Stamen Design</a>, <a href="http://creativecommons.org/licenses/by/3.0">CC BY 3.0</a> &mdash; Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',subdomains:"abcd",minZoom:0,maxZoom:20,ext:"png"},{BMKey:22,catID:"MISC",url:"https://{s}.tile.thunderforest.com/pioneer/{z}/{x}/{y}.png?apikey={key}",attribution:'&copy; <a href="http://www.thunderforest.com/">Thunderforest</a>, &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',keyProvider:"Thunderforest",maxZoom:22,BMname:"Thunderforest Pioneer",BMicon:"Thunderforest_Pioneer.png"},{BMKey:24,catID:"MISC",url:"https://tiles.stadiamaps.com/tiles/stamen_watercolor/{z}/{x}/{y}.{ext}",attribution:'Map tiles by <a href="http://stadiamaps.com">Stamen Design</a>, <a href="http://creativecommons.org/licenses/by/3.0">CC BY 3.0</a> &mdash; Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',subdomains:"abcd",minZoom:1,maxZoom:16,ext:"jpg",BMname:"Stamen Watercolor",BMicon:"Stamen_Watercolor.jpg"}],De=[{BMKey:5001,url:"https://tile.tracestrack.com/bicycle-route/{z}/{x}/{y}.png?key={key}",keyProvider:"tracestrack",BMname:"Bicycle",BMicon:"Tracestrack_Bike.png",attribution:'Data: \xA9 <a href="https://www.openstreetmap.org/copyright">OpenStreetMap contributors</a>, <a href="https://worldcover2021.esa.int">ESA WorldCover</a>; Maps \xA9 <a href="https://www.tracestrack.com/">Tracestrack</a>',minZoom:8,maxZoom:19},{BMKey:5e3,url:"https://tile.tracestrack.com/subway-route/{z}/{x}/{y}.png?key={key}",keyProvider:"tracestrack",BMname:"Subway",BMicon:"Tracestrack_Subway.png",attribution:'Data: \xA9 <a href="https://www.openstreetmap.org/copyright">OpenStreetMap contributors</a>, <a href="https://worldcover2021.esa.int">ESA WorldCover</a>; Maps \xA9 <a href="https://www.tracestrack.com/">Tracestrack</a>',minZoom:8,maxZoom:19},{BMKey:5002,url:"https://tile.tracestrack.com/bus-route/{z}/{x}/{y}.png?key={key}",keyProvider:"tracestrack",BMname:"Bus",BMicon:"Tracestrack_Bus.png",attribution:'Data: \xA9 <a href="https://www.openstreetmap.org/copyright">OpenStreetMap contributors</a>, <a href="https://worldcover2021.esa.int">ESA WorldCover</a>; Maps \xA9 <a href="https://www.tracestrack.com/">Tracestrack</a>',minZoom:8,maxZoom:19},{BMKey:5003,url:"https://tile.tracestrack.com/train-route/{z}/{x}/{y}.png?key={key}",keyProvider:"tracestrack",BMname:"Train",BMicon:"Tracestrack_Train.png",attribution:'Data: \xA9 <a href="https://www.openstreetmap.org/copyright">OpenStreetMap contributors</a>, <a href="https://worldcover2021.esa.int">ESA WorldCover</a>; Maps \xA9 <a href="https://www.tracestrack.com/">Tracestrack</a>',minZoom:0,maxZoom:19},{BMKey:5004,url:"https://tiles.openseamap.org/seamark/{z}/{x}/{y}.png",BMname:"Sea",BMicon:"openseamap.png",attribution:'Map data: &copy; <a href="http://www.openseamap.org">OpenSeaMap</a> contributors',minZoom:8}];var N={categories:xe,providerKeys:Oe,layers:Ne,overlays:De};const Pe=10,Ze=45.53,Ke=-73.71,Ae=0,ze=!1,Fe=25,Re="New map";var B={z:Pe,lat:Ze,lng:Ke,rot:Ae,m:ze,l:Fe,t:Re};const $={defaultState:0,url:1,device:2};var ne={youhere:{fr:"Vous \xEAtes ici",en:"You are here",es:"Usted est\xE1 aqu\xED"},expJson:{fr:"Exporter en JSON",en:"Export to JSON",es:"Exportar a JSON"}},$e={languages:{fr:"Fran\xE7ais",en:"English",es:"Espa\xF1ol"},fallback:"en"},ie="FR",se=$.defaultState,le="hsl(197, 100%, 60%)",Ge=window.location.search,c=new URLSearchParams(Ge),ce=c.has("z")==!0?Number(c.get("z")):B.z,de=c.has("lat")==!0?Number(c.get("lat")):B.lat,me=c.has("lng")==!0?Number(c.get("lng")):B.lng,pe=c.has("rot")==!0?Number(c.get("rot")):B.rot,X=c.has("m")==!0?c.get("m").toString()=="true":B.m,ue=c.has("t")==!0?c.get("t"):B.t,ge=c.has("l")==!0?c.get("l"):B.l;const Ue=1e3;c.has("lat")==!0&&c.has("lng")==!0&&(se=$.url);var f=[];for(const e of N.categories){var F={catID:e.catID,category:e.name_fr,layers:[]};for(const t of N.layers)if(t.catID==F.catID){var k=t.url;if(t.keyProvider!==void 0){var T=Be(t.keyProvider);T!==void 0&&(k=t.url.replace("{key}",T))}var l=L.tileLayer(k,{});t.BMKey!==void 0&&(l.options.BMKey=t.BMKey),t.BMname!==void 0&&(l.options.BMname=t.BMname),t.BMicon!==void 0&&(l.options.BMicon=t.BMicon),t.BMicon!==void 0&&(l.options.BMicon=t.BMicon),t.attribution!==void 0&&(l.options.attribution=t.attribution),t.minZoom!==void 0?l.options.minZoom=t.minZoom:l.options.minZoom=0,t.maxZoom!==void 0?l.options.maxZoom=t.maxZoom:l.options.maxZoom=22,t.subdomains!==void 0&&(l.options.subdomains=t.subdomains),t.ext!==void 0&&(l.options.ext=t.ext),l.options.isOverlay=!1,l.options.pane="tilePane",F.layers.push(l)}f.push(F)}var G=[];for(const e of N.overlays){var k=e.url;if(e.keyProvider!==void 0){var T=Be(e.keyProvider);T!==void 0&&(k=e.url.replace("{key}",T))}var l=L.tileLayer(k,{});e.BMKey!==void 0&&(l.options.BMKey=e.BMKey),e.BMname!==void 0&&(l.options.BMname=e.BMname),e.BMicon!==void 0&&(l.options.BMicon=e.BMicon),e.BMicon!==void 0&&(l.options.BMicon=e.BMicon),e.attribution!==void 0&&(l.options.attribution=e.attribution),e.minZoom!==void 0&&(l.options.minZoom=e.minZoom),e.maxZoom!==void 0&&(l.options.maxZoom=e.maxZoom),e.subdomains!==void 0&&(l.options.subdomains=e.subdomains),e.ext!==void 0&&(l.options.ext=e.ext),l.options.isOverlay=!0,l.options.pane="overlayPane",G.push(l)}var r=L.map("map",{center:new L.LatLng(de,me),zoom:ce,zoomControl:!1,rotate:!0,touchRotate:!0,rotateControl:!1,BMHasMarker:!1,BMTitle:ue,bearing:pe,attributionControl:!0,BMHasMeasure:!1,BMHasTracker:!1,BMCurrentLayerKey:0}),u={},_e=V(ge);r.addLayer(_e);document.getElementById("buildFld").value=Ce;L.control.sidepanel("panelID",{panelPosition:"left",hasTabs:!0,tabsPosition:"top",pushControls:!0,darkMode:!0,startTab:"tab-layer"}).addTo(r);var fe=L.control({position:"topright"});fe.onAdd=function(e){var t=L.DomUtil.create("div","info legend nArrow");return t.innerHTML="\u27F4",t};fe.addTo(r);var He=document.querySelector(".nArrow");He.addEventListener("click",function(e){r.setBearing(0)});let ye=L.control.polylineMeasure({position:"topright",unit:"kilometres",showBearings:!1,clearMeasurementsOnStop:!0,showClearControl:!1,showUnitControl:!1,startCircle:{color:"#000",weight:2,fillColor:"#0f0",fillOpacity:1,radius:6},intermedCircle:{color:"#000",weight:2,fillColor:"#ff0",fillOpacity:1,radius:4},currentCircle:{color:"#000",weight:1,fillColor:"#f0f",fillOpacity:1,radius:3},endCircle:{color:"#000",weight:2,fillColor:"#f00",fillOpacity:1,radius:6},tempLine:{color:"#00f",weight:1},fixedLine:{color:"#00C",weight:3}});ye.addTo(r);document.querySelector(".polyline-measure-unicode-icon").parentNode.style.display="none";r.on("rotate",function(e){P(q(r.getBearing()))});r.on("resizeend",function(e){y(S()),v(C()),x(Z())});r.on("zoomend",function(e){x(r.getZoom())});r.on("moveend",function(e){y(S()),v(C())});X?ke():K(X);et();Xe();tt();ot();mt();pt();gt();E(ue);P(pe);y(de);v(me);x(ce);we(ge);Me(!1);be(!1);let ve,U=!1,_=!1;var H=indexedDB.open("BestMapDB",1),b,h="BMFavorite";H.onerror=function(e){console.log("Database error: "+e.target.errorCode)};H.onsuccess=function(e){b=e.target.result,console.log("Database opened successfully"),Ie()};H.onupgradeneeded=function(e){b=e.target.result;var t=b.createObjectStore(h,{keyPath:"t"});t.createIndex("m","m",{unique:!1}),t.createIndex("rot","rot",{unique:!1}),t.createIndex("l","l",{unique:!1}),t.createIndex("lat","lat",{unique:!1}),t.createIndex("lng","lng",{unique:!1}),t.createIndex("z","z",{unique:!1})};document.getElementById("dlgUpload").style.display="none";document.getElementById("dlgconfirm").style.display="none";navigator.geolocation&&se==$.defaultState&&navigator.geolocation.getCurrentPosition(qe);function he(e,t){var o="en",a=void 0,n=t.toLowerCase();return n in e?a=e[n]:o in e&&(a=e[$e.fallback]),a}function qe(e){var t=e.coords,o=Ee(t.accuracy);A(),r.setView(new L.LatLng(t.latitude,t.longitude),o),E(he(ne.youhere,ie))}function Be(e){var t;for(const o of N.providerKeys)o.providerKeyName==e&&(t=o.providerKeyValue);return t}function M(e,t){var o=new URLSearchParams(window.location.search);o.set(e,t),window.history.pushState({},r.options.BMTitle,`${location.pathname}?${o.toString()}`)}function Ve(){return r.options.BMTitle}function E(e){r.options.BMTitle=e,document.getElementById("fTitle").value=e,document.title=`BestMap: ${e}`,r.options.BMHasMarker&&u.setTooltipContent(e),M("t",e)}function I(){return q(r.getBearing())}function P(e){document.getElementById("fRot").value=e,M("rot",e);var t=document.querySelector(".nArrow");t.style.transform=`rotate(${e-90}deg)`,e==0?t.style.display="none":t.style.display="block"}function y(e){document.getElementById("fLat").value=e,M("lat",e)}function S(){var e;return r.options.BMHasMarker?e=u.getLatLng().lat:e=r.getCenter().lat,e}function C(){var e;return r.options.BMHasMarker?e=u.getLatLng().lng:e=r.getCenter().lng,e}function v(e){document.getElementById("fLng").value=e,M("lng",e)}function Z(){return r.getZoom()}function x(e){document.getElementById("fZoom").value=e,M("z",e)}function K(e){e?(u.setTooltipContent(r.options.BMTitle),document.getElementById("btFlipMarker").style.backgroundImage="url('icons/removeMarker.png')"):document.getElementById("btFlipMarker").style.backgroundImage="url('icons/addMarker.png')",M("m",e)}function Me(e){e?document.getElementById("btMeasure").style.backgroundImage="url('icons/removeMeasure.png')":document.getElementById("btMeasure").style.backgroundImage="url('icons/addMeasure.png')"}function be(e){e?document.getElementById("btTrack").style.backgroundImage="url('icons/removeTrack.png')":document.getElementById("btTrack").style.backgroundImage="url('icons/addTrack.png')"}function Ee(e){var a=18-Math.log(e)/Math.log(10);return a=Math.max(0,Math.min(a,18)),a}function We(e){var t=e.coords,o=Ee(t.accuracy);A(),r.flyTo(new L.LatLng(t.latitude,t.longitude),o),r.once("moveend zoomend",function(){j(t.latitude,t.longitude),E(he(ne.youhere,ie))})}function je(e){e.code==1?console.log("getCurrentPosition Error: Access is denied!"):e.code==2&&console.log("getCurrentPosition Error: Position is unavailable!")}function q(e){var t=parseInt(e);return e<0?t=360- -e%360:t=e%360,parseInt(t)}function Je(e){var t=parseFloat(e);return t>90&&(t=90),t<-90&&(t=-90),t}function Ye(e){var t=parseFloat(e);return t>180&&(t=180),t<-180&&(t=-180),t}function Qe(e){var t=parseInt(e);return t>r.maxZoom&&(t=r.maxZoom),t<r.minZoom&&(t=r.minZoom),t}function R(e){var t=parseInt(e);isNaN(t)&&(t=0),r.eachLayer(function(o){"isOverlay"in o.options&&(o.options.isOverlay||r.removeLayer(o))}),r.addLayer(V(t)),we(t)}function ee(e){var t=parseInt(e);if(!isNaN(t)){var o=!0,a=document.getElementById(`BMOverlay-${t}`),n=a.getElementsByTagName("img")[0];if(r.eachLayer(function(i){i.options.BMKey==t&&(o=!1,r.removeLayer(i),n.style.borderColor="black")}),o)for(const i of G)i.options.BMKey==t&&(r.addLayer(i),n.style.borderColor=le)}}function Xe(){var e=document.getElementById("BM-Overlay-Nav-Panel"),t='<div class="BM-Layer-Nav-Container">';for(const a of G){var o=`BMOverlay-${a.options.BMKey}`;t+=`<div class="BM-Over-Bt" id="${o}" data-bmkey="${a.options.BMKey}" >
              <img src='layerIcons/${a.options.BMicon}' title='${a.options.BMname}'>
              <div class="BM-Layer-Bt-Name">${a.options.BMname}</div>
            </div>`}t+="</div>",e.innerHTML=t}function et(){for(var e=document.getElementById("BM-Layer-Nav-Panel"),t=0,o=0;o<f.length;o++){for(var a='<div class="BM-Layer-Nav-Container">',n=f[o].layers,i=0;i<n.length;i++){var m=`BMLayer-${t}`;a+=`<div class="BM-Layer-Bt" id="${m}" data-bmkey="${f[o].layers[i].options.BMKey}" >
              <img src='layerIcons/${n[i].options.BMicon}' title='${f[o].layers[i].options.BMname}'>
              <div class="BM-Layer-Bt-Name">${f[o].layers[i].options.BMname}</div>
            </div>`,t++}a+="</div>";var p=`<div class="BM-Layer-Nav-Category">${f[o].category}</div>${a}`;e.innerHTML+=p}}function V(e){var t,o,a=parseInt(e);isNaN(a)&&(a=0);for(var n=0;n<f.length;n++){o=f[n].layers;for(var i=0;i<o.length;i++)n===0&&i===0&&(t=o[i]),o[i].options.BMKey===a&&(t=o[i])}return t}function we(e){for(var t=document.querySelectorAll(".BM-Layer-Bt"),o=0;o<t.length;o++){var a=t[o].getElementsByTagName("img")[0];t[o].dataset.bmkey==e?a.style.borderColor=le:a.style.borderColor="black"}document.getElementById("fLayer").value=V(e).options.BMname,document.getElementById("fLayerID").value=e,M("l",e),r.options.BMCurrentLayerKey=e}function tt(){document.addEventListener("click",function(e){if(e.target.matches(".BM-Layer-Bt img")){var t=e.target.parentNode.dataset.bmkey;R(t)}if(e.target.matches(".BM-Layer-Bt div")){var t=e.target.parentNode.dataset.bmkey;R(t)}},!1)}function ot(){document.addEventListener("click",function(e){if(e.target.matches(".BM-Over-Bt img")){var t=e.target.parentNode.dataset.bmkey;ee(t)}if(e.target.matches(".BM-Over-Bt div")){var t=e.target.parentNode.dataset.bmkey;ee(t)}},!1)}function O(){return r.options.BMHasMarker?u.getLatLng():r.getCenter()}const at=document.querySelector("#btSelFavFile");at.addEventListener("change",e=>{if(e.target.files.length==1){const[t]=e.target.files,{name:o,size:a}=t,n=(a/1e3).toFixed(2),i=`${o} (${n}KB)`;document.querySelector("#selectedFavFileName").textContent=i,document.querySelector("#btFavDoUpload").style.display="block"}else document.querySelector("#selectedFavFileName").textContent="",document.querySelector("#btFavDoUpload").style.display="none"});function rt(){document.getElementById("dlgUpload").style.display="block"}function nt(e){let t=e.target.result,o=JSON.parse(t);var a=document.getElementById("FavTableBody");a.innerHTML="";for(let i=0;i<o.length;i++){var n=o[i];W(n.t,n.m,n.rot,n.lat,n.lng,n.z,n.l)}}function it(){document.getElementById("dlgUpload").style.display="none"}function st(){let e=document.getElementById("btSelFavFile");if(!e.value.length)return;let t=new FileReader;t.onload=nt,t.readAsText(e.files[0]),document.getElementById("dlgUpload").style.display="none"}function te(e,t,o){const a=document.createElement("a"),n=new Blob([e],{type:o});a.href=URL.createObjectURL(n),a.download=t,a.click()}function lt(e){var t=b.transaction([h],"readonly"),o=t.objectStore(h),a=o.getAll();a.onsuccess=function(n){var i=n.target.result;console.log("Data read successfully"),e(i)},a.onerror=function(n){console.log("Error reading data: "+n.target.errorCode)}}function Ie(){lt(function(e){var t;for(t of e)W(t.t,t.m,t.rot,t.lat,t.lng,t.z,t.l);Te("FavTable",0,!1)})}function ct(){var e=b.transaction([h],"readwrite"),t=e.objectStore(h),o=t.clear();o.onsuccess=function(a){console.log("All data deleted successfully")},o.onerror=function(a){console.log("Error deleting all data: "+a.target.errorCode)}}function dt(e){var t=b.transaction([h],"readwrite"),o=t.objectStore(h),a=o.add(e);a.onsuccess=function(n){console.log("Data inserted successfully")},a.onerror=function(n){console.log("Error inserting data: "+n.target.errorCode)}}function W(e,t,o,a,n,i,m){const d=document.getElementById("FavTableBody").insertRow(0);var g=self.crypto.randomUUID(),w=self.crypto.randomUUID(),J=self.crypto.randomUUID(),Y=self.crypto.randomUUID(),Le=self.crypto.randomUUID(),Q="";Q=`
  <tr id="${Le}">
    <td id="${g}" class="BM-Table-Input" contenteditable="true">${e}</td>
    <td id="${w}" class="BM-Table-Icon" ><img src="./icons/favView.png"></td>
    <td id="${J}" class="BM-Table-Icon"><img src="./icons/favUpdate.png"</td>
    <td id="${Y}" class="BM-Table-Icon"><img src="./icons/favDelete.png"</td>
  </tr>`,d.innerHTML=Q,d.dataset.m=t,d.dataset.t=e,d.dataset.rot=o,d.dataset.lat=a,d.dataset.lng=n,d.dataset.z=i,d.dataset.l=m,document.getElementById(w).addEventListener("click",function(){var s=this.parentNode.dataset;A(),r.panTo({lng:Number(s.lng),lat:Number(s.lat)}),r.setZoom(s.z),x(s.z),r.setBearing(Number(s.rot)),R(Number(s.l)),r.options.BMTitle=s.t,console.log(`GB: BMHasMarker = ${r.options.BMHasMarker}`),console.log(`GB: theUrlObj = ${JSON.stringify(s)}`),console.log(`GB: theUrlObj m type = ${typeof s.m}`),s.m=="true"&&(j(s.lat,s.lng),K(!0),r.options.BMHasMarke=!0,r.panTo({lng:Number(s.lng),lat:Number(s.lat)})),r.panTo({lng:Number(s.lng),lat:Number(s.lat)}),y(Number(s.lat)),v(Number(s.lng)),E(s.t)}),document.getElementById(J).addEventListener("click",function(){var s=this.parentNode.dataset;document.getElementById("dlgconfirm").style.display="block",document.getElementById("conQuestion").innerText=`Do you update the saved view for: ${s.t}?`,document.getElementById("btConfNo").addEventListener("click",function(){document.getElementById("dlgconfirm").style.display="none"}),document.getElementById("btConfYes").addEventListener("click",function(){s.m=r.options.BMHasMarker,s.rot=I(),s.lat=S(),s.lng=C(),s.z=Z(),s.l=r.options.BMCurrentLayerKey,document.getElementById("dlgconfirm").style.display="none"})}),document.getElementById(Y).addEventListener("click",function(){this.parentNode.remove()}),document.getElementById(g).addEventListener("input",function(s){var z=s.target.innerText;r.options.BMTitle!==z&&E(z),this.parentNode.dataset.t=z})}function mt(){document.getElementById("btGoOSM").addEventListener("click",function(){var e=O(),t=r.getZoom(),o=`https://www.openstreetmap.org/#map=${t}/${e.lat}/${e.lng}`;window.open(o)}),document.getElementById("btGoGoogle").addEventListener("click",function(){var e=O(),t=`https://www.google.com/maps/search/?api=1&query=${e.lat},${e.lng}`;window.open(t)}),document.getElementById("btGoGoogleEarth").addEventListener("click",function(){var e=O(),t=r.getZoom(),o=I(),a=Math.pow(2,20-t)*4096;console.log(`z=${t} d=${a}`);var n=`https://earth.google.com/web/@${e.lat},${e.lng},${a}d,${-o}h`;window.open(n)}),document.getElementById("btGoBing").addEventListener("click",function(){var e=O(),t=r.getZoom(),o=I(),a=-o,n=`https://www.bing.com/maps?cp=${e.lat}~${e.lng}&lvl=${t}&dir=${a}`;console.log(n),window.open(n)}),document.getElementById("btFavAdd").addEventListener("click",function(){W("*** name ***",r.options.BMHasMarker,I(),S(),C(),Z(),r.options.BMCurrentLayerKey)}),document.getElementById("btFavSave").addEventListener("click",function(){ct();for(var e=document.getElementById("FavTableBody"),t=0,o;o=e.rows[t];t++){var a={t:o.dataset.t,m:o.dataset.m,rot:o.dataset.rot,l:o.dataset.l,lat:o.dataset.lat,lng:o.dataset.lng,z:o.dataset.z};dt(a)}}),document.getElementById("btFavUndo").addEventListener("click",function(){var e=document.getElementById("FavTableBody");e.innerHTML="",Ie()}),document.getElementById("btFavExport").addEventListener("click",function(){for(var e=document.getElementById("FavTableBody"),t=[],o=0,a;a=e.rows[o];o++){var n={t:a.dataset.t,m:a.dataset.m,rot:a.dataset.rot,l:a.dataset.l,lat:a.dataset.lat,lng:a.dataset.lng,z:a.dataset.z};t.push(n)}te(JSON.stringify(t),"BMFavorites.json","text/plain")}),document.getElementById("btFavToGeoJSON").addEventListener("click",function(){for(var e=document.getElementById("FavTableBody"),t="",o=0,a;a=e.rows[o];o++){var n=`{
        "type": "Feature",
        "geometry": {
          "type": "Point",
          "coordinates": [${a.dataset.lng},${a.dataset.lat}]
        },
        "properties": {
          "name": "${a.dataset.t}",
          "rotation": ${a.dataset.rot},
          "tilez" : ${a.dataset.z},
          "layerid" : ${a.dataset.l},
          "hasmarker" : ${a.dataset.m}
        }
      }`;t+=o!=0?`,${n}`:n}var i=`{
      "type": "FeatureCollection",
      "features": [${t}]
    }`;te(i,"BMFavorites.geojson","text/plain")}),document.getElementById("btFavImport").addEventListener("click",rt),document.getElementById("btFavCancelUpload").addEventListener("click",it),document.getElementById("btFavDoUpload").addEventListener("click",st),document.getElementById("btFlipMarker").addEventListener("click",function(){ft()}),document.getElementById("btTrack").addEventListener("click",function(){Et()}),document.getElementById("btGoHere").addEventListener("click",function(){navigator.geolocation&&navigator.geolocation.getCurrentPosition(We,je)}),document.getElementById("shareToClipboard").addEventListener("click",function(){navigator.clipboard.writeText(window.location.href)}),document.getElementById("shareToMail").addEventListener("click",function(){var e=encodeURIComponent(window.location.href),t=encodeURIComponent(r.options.BMTitle),o=`mailto:?subject=${t}&body=${t}%0A${e}`;document.location=o}),document.getElementById("btMeasure").addEventListener("click",function(){ye._toggleMeasure(),r.options.BMHasMeasure=!r.options.BMHasMeasure,Me(r.options.BMHasMeasure)}),document.getElementById("headFavPlace").addEventListener("click",function(){Te("FavTable",0,!1)})}function oe(){document.getElementById("btEdit").style.display="inline-block",document.getElementById("btEditSave").style.display="none",document.getElementById("btEditCancel").style.display="none",document.getElementById("fTitle").disabled=!0,document.getElementById("fRot").disabled=!0,document.getElementById("fLat").disabled=!0,document.getElementById("fLng").disabled=!0,document.getElementById("fZoom").disabled=!0}function pt(){var e,t,o,a,n;document.getElementById("btEdit").addEventListener("click",function(){e=Ve(),t=I(),o=S(),a=C(),n=Z(),document.getElementById("btEdit").style.display="none",document.getElementById("btEditSave").style.display="inline-block",document.getElementById("btEditCancel").style.display="inline-block",document.getElementById("fTitle").disabled=!1,document.getElementById("fRot").disabled=!1,document.getElementById("fLat").disabled=!1,document.getElementById("fLng").disabled=!1,document.getElementById("fZoom").disabled=!1}),document.getElementById("btEditSave").addEventListener("click",function(){oe();var i=document.getElementById("fTitle").value;i!=e&&E(i);var m=q(document.getElementById("fRot").value);m!=t&&(r.setBearing(m),P(m));var p=Je(document.getElementById("fLat").value),d=Ye(document.getElementById("fLng").value);(p!=o||d!=a)&&(r.panTo(new L.LatLng(p,d),g),p!=o&&y(p),d!=a&&v(d));var g=Qe(document.getElementById("fZoom").value);g!=n&&(r.setZoom(g),x(g))}),document.getElementById("btEditCancel").addEventListener("click",function(){oe(),document.getElementById("fTitle").value=e,document.getElementById("fRot").value=t})}function ut(e){if(console.log(e),Array.isArray(e.results)&&e.results.length>0){var t=e.results[0],o=t.geometry.lat,a=t.geometry.lng;r.panTo(new L.LatLng(o,a),{}),y(o),v(a)}}function gt(){document.getElementById("fSearch").addEventListener("change",function(){var e=document.getElementById("fSearch").value,t="a1f15d3f6b834c55917fd7e435af418c",o=`https://api.opencagedata.com/geocode/v1/json?q=${e}&key=${t}`;console.log(e),fetch(o).then(a=>a.json()).then(a=>ut(a))})}function j(e,t){u=new L.Marker([e,t],{draggable:!0}),u.bindTooltip(r.options.BMTitle),u.on("dragend",function(o){var a=u.getLatLng().lat,n=u.getLatLng().lng;y(a),v(n)}),r.addLayer(u),r.options.BMHasMarker=!0,K(!0)}function ke(){var e=r.getCenter().lat,t=r.getCenter().lng;j(e,t)}function ft(){yt()?A():ke()}function yt(){var e=!1;return r.eachLayer(t=>{t instanceof L.Marker&&(e=!0)}),e}function A(){r.eachLayer(e=>{e instanceof L.Marker&&e.remove()}),r.options.BMHasMarker=!1,K(!1)}function ae(){window.DeviceMotionEvent&&window.DeviceMotionEvent.requestPermission?window.DeviceMotionEvent.requestPermission().then(e=>{e==="granted"&&window.addEventListener("devicemotion",D)}).catch(console.error):window.DeviceOrientationEvent?window.addEventListener("deviceorientationabsolute",D):console.log("Device motion or orientation is not supported by this browser.")}function D(e){let t=null;if(e.rotationRate?t=e.rotationRate.alpha:e.alpha&&(t=e.alpha),t!==null){const o=t;_&&(r.setBearing(o),P(o))}}function vt(){_=!0,ae(),setInterval(ae,Ue)}function ht(){_=!1,window.DeviceMotionEvent&&window.DeviceMotionEvent.requestPermission?window.removeEventListener("devicemotion",D):window.DeviceOrientationEvent&&window.removeEventListener("deviceorientationabsolute",D)}function re(){navigator.geolocation?navigator.geolocation.getCurrentPosition(Bt):console.log("Geolocation is not supported by this browser.")}function Bt(e){var t=e.coords.latitude,o=e.coords.longitude;U&&(y(t),v(o),r.panTo({lng:o,lat:t}))}function Mt(){U=!0,re(),ve=setInterval(re,1e4)}function bt(){U=!1,clearInterval(ve)}function Et(){r.options.BMHasTracker?(L.geotagPhoto.crosshair().removeFrom(r),document.querySelectorAll(".leaflet-geotag-photo-crosshair").forEach(t=>t.remove()),bt(),ht()):(L.geotagPhoto.crosshair().addTo(r).on("input",function(e){this.getCrosshairPoint()}),Mt(),vt()),r.options.BMHasTracker=!r.options.BMHasTracker,be(r.options.BMHasTracker)}function Te(e,t,o=!1){const a=document.getElementById(e),n=a.querySelector("tbody"),i=Array.from(n.getElementsByTagName("tr")),m=a.querySelector("thead tr");i.sort((p,d)=>{const g=p.getElementsByTagName("td")[t].textContent.trim(),w=d.getElementsByTagName("td")[t].textContent.trim();return o?w.localeCompare(g):g.localeCompare(w)}),o&&i.reverse(),n.innerHTML="",i.forEach(p=>n.appendChild(p)),a.querySelector("thead").appendChild(m)}
